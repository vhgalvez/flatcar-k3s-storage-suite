# playbooks/05_copy_token.yml
---
- name: 📥 Copiar token JWT desde master al controller
  hosts: controller
  become: true
  gather_facts: false

  vars:
    ansible_python_interpreter: /usr/bin/python3
    remote_token_path: "/tmp/traefik-token.jwt"
    local_token_path: "/home/monitoring/.kube/token.jwt"

  tasks:
    - name: 📁 Crear carpeta destino
      file:
        path: "{{ local_token_path | dirname }}"
        state: directory
        owner: monitoring
        group: monitoring
        mode: '0755'

    - name: 📥 Copiar token localmente (controller == master)
      copy:
        src: "{{ remote_token_path }}"
        dest: "{{ local_token_path }}"
        remote_src: yes
        owner: monitoring
        group: monitoring
        mode: '0600'

    - name: 🔒 Verificar token copiado
      command: cat {{ local_token_path }}
      register: token_check
      changed_when: false

    - name: 📦 Token copiado al controller
      debug:
        var: token_check.stdout
