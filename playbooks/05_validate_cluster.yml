# playbooks\05_validate_cluster.yml
---
- name: 🚀 5 - Validar la instalación de Longhorn
  hosts: controller
  become: true
  gather_facts: false

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    longhorn_namespace: "longhorn-system"

  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH }}"
    KUBECONFIG: "{{ kubeconfig_path }}"

  pre_tasks:

    - name: 🔍 Comprobar si existe el namespace Longhorn
      shell: kubectl get namespace {{ longhorn_namespace }} || true
      register: ns_check
      changed_when: false

    - name: 🔍 Verificar si hay recursos en el namespace Longhorn
      shell: kubectl get all -n {{ longhorn_namespace }} || true
      register: longhorn_check
      changed_when: false
      when: "'NotFound' not in ns_check.stdout"

  tasks:

    - name: 📊 Mostrar estado de los pods, PVCs y PVs
      shell: |
        echo "📦 Pods:"
        kubectl get pods -n {{ longhorn_namespace }}

        echo ""
        echo "📁 PVCs:"
        kubectl get pvc -A

        echo ""
        echo "📦 PVs:"
        kubectl get pv -A

    - name: 📄 Mostrar recursos detectados si el namespace existe
      debug:
        msg: |
          ⚠️ El namespace '{{ longhorn_namespace }}' contiene recursos de una instalación anterior.
          Recursos detectados:
          {{ longhorn_check.stdout }}
      when: "'NotFound' not in ns_check.stdout"  
