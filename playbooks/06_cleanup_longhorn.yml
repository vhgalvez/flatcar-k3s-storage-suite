---
# playbooks\06_cleanup_longhorn.yml
- name: â™»ï¸ Limpieza completa de Longhorn en controller, storage y workers
  hosts: controller,storage,workers
  become: true
  gather_facts: false

  vars:
    kubeconfig_path: "/home/victory/.kube/config"

  pre_tasks:
    - name: âœ… ConfirmaciÃ³n requerida
      assert:
        that:
          - confirm_cleanup | default(false) | bool
        fail_msg: "âŒ ERROR: Debe confirmar con -e 'confirm_cleanup=yes'"
        success_msg: "ğŸ§¹ ConfirmaciÃ³n recibida en {{ inventory_hostname }}"

    - name: ğŸ›‘ Verificar que /dev/vdb no estÃ© montado como disco del sistema
      raw: |
        mount | grep /dev/vdb | grep -E '/($|/boot|/home)' && exit 1 || exit 0
      register: vdb_mount_check
      failed_when: vdb_mount_check.rc != 0
      changed_when: false
      ignore_errors: false
      when: "'storage' in group_names or 'workers' in group_names"
      tags: safety

  tasks:

    ## CONTROLLER ...

    ## [MISMA LÃ“GICA DEL CONTROLLER QUE YA TIENES] ##

    ## STORAGE
    - name: ğŸ”Œ Desmontar volÃºmenes en storage
      raw: |
        umount -f /srv/nfs/postgresql || true
        umount -f /srv/nfs/shared || true
        umount -f /mnt/longhorn-disk || true
      ignore_errors: true
      when: "'storage' in group_names"

    - name: ğŸ›‘ Detener y deshabilitar servicio NFS
      raw: |
        systemctl stop nfs-server || rc-service nfs stop || true
        systemctl disable nfs-server || true
      ignore_errors: true
      when: "'storage' in group_names"

    - name: ğŸ§¹ Borrar contenido de /srv/nfs y /mnt/longhorn-disk
      raw: |
        rm -rf /srv/nfs/* /mnt/longhorn-disk/*
      ignore_errors: true
      when: "'storage' in group_names"

    - name: ğŸ—‘ï¸ Eliminar volÃºmenes lÃ³gicos
      raw: |
        lvremove -fy /dev/vg_storage/postgres_lv || true
        lvremove -fy /dev/vg_storage/shared_lv || true
        lvremove -fy /dev/vg_storage/longhorn_lv || true
      ignore_errors: true
      when: "'storage' in group_names"

    - name: ğŸ§± Eliminar grupo de volÃºmenes
      raw: vgremove -fy vg_storage || true
      ignore_errors: true
      when: "'storage' in group_names"

    - name: ğŸ’£ Borrar firmas y particiÃ³n
      raw: |
        pvremove -y /dev/vdb1 || true
        parted /dev/vdb rm 1 || true
        wipefs -a /dev/vdb || true
      ignore_errors: true
      when: "'storage' in group_names"

    ## WORKER
    - name: ğŸ’¥ Borrar sistema de archivos en /dev/vdb (workers)
      raw: wipefs -a /dev/vdb || true
      ignore_errors: true
      when: "'workers' in group_names"

    # FINAL
    - name: âœ… ConfirmaciÃ³n final
      debug:
        msg: "âœ… Limpieza finalizada en {{ inventory_hostname }}. Puedes reiniciar este nodo si lo deseas."