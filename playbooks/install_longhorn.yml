- name: Instalar Longhorn usando Helm
  hosts: controller  # Cambiar "masters" a "controller" (o el nodo donde tienes helm instalado)
  gather_facts: false
  become: true
  vars:
    longhorn_namespace: "longhorn-system"
    kubeconfig_path: "/home/victory/.kube/config"  # Ruta correcta del kubeconfig

  tasks:
    # Añadir el repositorio de Helm para Longhorn
    - name: Añadir repositorio Helm de Longhorn
      raw: |
        export KUBECONFIG={{ kubeconfig_path }}
        helm repo add longhorn https://charts.longhorn.io
        helm repo update
      register: helm_repo

    # Instalar Longhorn usando Helm
    - name: Instalar Longhorn usando Helm
      raw: |
        export KUBECONFIG={{ kubeconfig_path }}
        helm install longhorn longhorn/longhorn --namespace {{ longhorn_namespace }} --create-namespace
      register: longhorn_install
      failed_when: longhorn_install.rc != 0

    # Esperar a que los pods de Longhorn estén listos (máx 5 minutos)
    - name: Esperar a que los pods de Longhorn estén listos (máx 5 minutos)
      raw: |
        export KUBECONFIG={{ kubeconfig_path }}
        kubectl --namespace {{ longhorn_namespace }} wait --for=condition=Ready pod --all --timeout=300s
      register: wait_longhorn
      failed_when: wait_longhorn.rc != 0

    # Mostrar estado final de los pods de Longhorn
    - name: Mostrar estado final de los pods de Longhorn
      raw: |
        export KUBECONFIG={{ kubeconfig_path }}
        kubectl --namespace {{ longhorn_namespace }} get pods
      register: longhorn_pods

    # Imprimir lista de los pods Longhorn
    - name: Imprimir lista de pods Longhorn
      debug:
        var: longhorn_pods.stdout_lines