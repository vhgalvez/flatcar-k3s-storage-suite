---
- name: ğŸ§¹ 0ï¸âƒ£ Eliminar ServiceAccount 'default' en namespace 'default'
  hosts: masters
  become: true
  gather_facts: false

  vars:
    ansible_python_interpreter: /bin/false  # Flatcar no tiene Python

  tasks:

    - name: ğŸ” Verificar si kubectl estÃ¡ disponible
      raw: |
        command -v k3s && k3s kubectl version --client=true
      register: kubectl_check
      failed_when: kubectl_check.rc != 0

    - name: ğŸ§¹ Eliminar ServiceAccount 'default' si existe (namespace default)
      raw: |
        k3s kubectl delete serviceaccount default --ignore-not-found=true --namespace default
      register: sa_delete

    - name: ğŸ“¦ Resultado de la eliminaciÃ³n del SA default
      debug:
        var: sa_delete.stdout_lines

# â¬‡ï¸ GeneraciÃ³n del token seguro con nueva ServiceAccount
- name: ğŸ” 0ï¸âƒ£ Generar token JWT en master con permisos adecuados
  hosts: masters[0]
  gather_facts: false
  become: true

  vars:
    kubeconfig_path: "/etc/rancher/k3s/k3s.yaml"
    local_token_path: "/tmp/traefik-token.jwt"
    token_duration: "87600h"
    serviceaccount_name: "remote-access"
    rolebinding_name: "remote-access-admin"

  tasks:

    - name: ğŸ§¹ Eliminar ServiceAccount '{{ serviceaccount_name }}' si existe
      shell: |
        k3s kubectl delete serviceaccount {{ serviceaccount_name }} --ignore-not-found=true
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: ğŸ§¹ Eliminar ClusterRoleBinding '{{ rolebinding_name }}' si existe
      shell: |
        k3s kubectl delete clusterrolebinding {{ rolebinding_name }} --ignore-not-found=true
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: ğŸ§¾ Crear ServiceAccount '{{ serviceaccount_name }}'
      shell: |
        k3s kubectl create serviceaccount {{ serviceaccount_name }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: ğŸ”‘ Crear ClusterRoleBinding '{{ rolebinding_name }}' con permisos de admin
      shell: |
        k3s kubectl create clusterrolebinding {{ rolebinding_name }} \
          --clusterrole=cluster-admin \
          --serviceaccount=default:{{ serviceaccount_name }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: ğŸ” Generar token JWT para ServiceAccount '{{ serviceaccount_name }}'
      shell: |
        k3s kubectl create token {{ serviceaccount_name }} --duration={{ token_duration }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: token_output
      changed_when: false

    - name: ğŸ“„ Guardar token localmente en el master
      shell: |
        echo "{{ token_output.stdout }}" > {{ local_token_path }}

    - name: ğŸŸ¢ Token generado correctamente
      debug:
        var: token_output.stdout
      no_log: true