# playbooks/05_ingress-longhorn-internal.yml
---
- name: 🚪 5 - Exponer Longhorn Dashboard con IngressRoute Interno
  hosts: controller
  become: true
  gather_facts: false

  vars:
    longhorn_namespace: longhorn-system
    dashboard_auth_secret: longhorn-dashboard-auth
    domain: longhorn.socialdevs.site
    kubeconfig_path: "/home/victory/.kube/config"
    kubectl_bin: "/usr/local/bin/kubectl"

  tasks:
    - name: ⚠️ Verificar si ya existe el Secret de autenticación
      shell: |
        export KUBECONFIG={{ kubeconfig_path }}
        {{ kubectl_bin }} get secret {{ dashboard_auth_secret }} -n {{ longhorn_namespace }} --ignore-not-found
      register: auth_secret_check
      changed_when: false

    - name: ❌ Abortamos si ya existe un Secret con ese nombre (evitar sobrescritura)
      fail:
        msg: |
          ⚠️ El Secret '{{ dashboard_auth_secret }}' ya existe en el namespace '{{ longhorn_namespace }}'.
          Si deseas regenerarlo, primero elimínalo manualmente:
            {{ kubectl_bin }} delete secret {{ dashboard_auth_secret }} -n {{ longhorn_namespace }}
      when: auth_secret_check.stdout | length > 0

    - name: 📁 Renderizar Middleware de autenticación
      template:
        src: templates/longhorn/middleware-auth.yaml.j2
        dest: /tmp/longhorn-middleware-auth.yaml
      vars:
        secret_name: "{{ dashboard_auth_secret }}"
        namespace: "{{ longhorn_namespace }}"

    - name: 📁 Renderizar IngressRoute interno de Longhorn
      template:
        src: templates/longhorn/ingressroute-internal.yaml.j2
        dest: /tmp/longhorn-ingressroute-internal.yaml
      vars:
        domain: "{{ domain }}"
        middleware_name: "longhorn-dashboard-auth"
        namespace: "{{ longhorn_namespace }}"

    - name: 🚀 Aplicar Middleware (auth)
      shell: |
        export KUBECONFIG={{ kubeconfig_path }}
        {{ kubectl_bin }} apply -f /tmp/longhorn-middleware-auth.yaml

    - name: 🚀 Aplicar IngressRoute (Interno)
      shell: |
        export KUBECONFIG={{ kubeconfig_path }}
        {{ kubectl_bin }} apply -f /tmp/longhorn-ingressroute-internal.yaml