---
# Ruta: playbooks\validate_all.yml
# âœ… VerificaciÃ³n completa del entorno desplegado con Ansible

- name: âœ… Validar almacenamiento en nodo de storage
  hosts: storage
  become: true
  gather_facts: false
  tasks:
    - name: ğŸ“‚ Validar montajes NFS
      raw: mount | grep -E "/srv/nfs/postgresql|/srv/nfs/shared"
      register: storage_mounts
      failed_when: storage_mounts.rc != 0

    - name: ğŸ“¦ Verificar volumen LVM longhorn_lv
      raw: lvdisplay /dev/vg_storage/longhorn_lv
      register: longhorn_lv_check
      failed_when: longhorn_lv_check.rc != 0

    - name: ğŸŸ¢ Mostrar resultados de montajes
      debug:
        var: storage_mounts.stdout_lines

- name: âœ… Validar configuraciÃ³n de discos Longhorn en workers
  hosts: workers
  become: true
  gather_facts: false
  tasks:
    - name: ğŸ“ Verificar /mnt/longhorn-disk montado
      raw: mountpoint -q /mnt/longhorn-disk
      register: mount_check
      failed_when: mount_check.rc != 0

    - name: ğŸ” Verificar sistema de archivos en /dev/vdb
      raw: blkid /dev/vdb || true
      register: fs_check
      failed_when: fs_check.rc != 0

    - name: âš™ï¸ Verificar presencia de iscsiadm
      raw: which iscsiadm || true
      register: iscsi_check
      failed_when: iscsi_check.rc != 0

    - name: ğŸ“Š Mostrar estado del montaje
      debug:
        var: mount_check

- name: âœ… Validar despliegue de Longhorn desde master1
  hosts: master1
  become: true
  gather_facts: false
  vars:
    kubeconfig_path: "/etc/rancher/k3s/k3s.yaml"
    longhorn_namespace: "longhorn-system"
  tasks:
    - name: ğŸ” Verificar namespace longhorn-system
      raw: k3s kubectl --kubeconfig {{ kubeconfig_path }} get ns {{ longhorn_namespace }}
      register: ns_check
      failed_when: ns_check.rc != 0

    - name: ğŸ·ï¸ Verificar etiquetas de nodos
      raw: k3s kubectl --kubeconfig {{ kubeconfig_path }} get nodes --show-labels | grep longhorn-node
      register: label_check
      failed_when: label_check.rc != 0

    - name: ğŸ“¦ Verificar pods de Longhorn
      raw: k3s kubectl --kubeconfig {{ kubeconfig_path }} -n {{ longhorn_namespace }} get pods
      register: pod_list

    - name: âŒ Verificar errores en pods
      raw: k3s kubectl --kubeconfig {{ kubeconfig_path }} -n {{ longhorn_namespace }} get pods | grep -E "CrashLoopBackOff|Error|Pending" || true
      register: pod_errors

    - name: ğŸ“„ Mostrar lista de pods
      debug:
        var: pod_list.stdout_lines

    - name: âš ï¸ Mostrar errores de pods (si existen)
      debug:
        var: pod_errors.stdout_lines
      when: pod_errors.stdout != ""

    - name: ğŸ“ Validar PVCs y PVs
      raw: |
        k3s kubectl --kubeconfig {{ kubeconfig_path }} get pvc --all-namespaces
        k3s kubectl --kubeconfig {{ kubeconfig_path }} get pv
      register: pvc_pv_check

    - name: ğŸ“„ Mostrar PVCs y PVs
      debug:
        var: pvc_pv_check.stdout_lines
