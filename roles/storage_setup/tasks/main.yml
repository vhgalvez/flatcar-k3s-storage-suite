---
# roles/storage_setup/tasks/main.yml

- name: üõë Detener servicios que puedan usar /dev/vdb
  raw: |
    systemctl stop nfs-server || true
  ignore_errors: true

- name: üíΩ Eliminar vol√∫menes antiguos (si existen)
  raw: |
    umount -f /srv/nfs/postgresql || true
    umount -f /srv/nfs/shared || true
    umount -f /mnt/longhorn-disk || true
    lvremove -fy /dev/vg_data/postgresql_lv || true
    lvremove -fy /dev/vg_data/shared_lv || true
    lvremove -fy /dev/vg_data/longhorn_lv || true
    vgremove -fy vg_data || true
    pvremove -ff -y /dev/vdb || true

- name: ‚ûï Crear volumen f√≠sico y grupo de vol√∫menes
  raw: |
    pvcreate /dev/vdb
    vgcreate vg_data /dev/vdb

- name: ‚ûï Crear vol√∫menes l√≥gicos
  raw: |
    lvcreate -L 10G -n postgresql_lv vg_data
    lvcreate -L 10G -n shared_lv vg_data
    lvcreate -L 59G -n longhorn_lv vg_data

- name: üß± Formatear vol√∫menes con ext4
  raw: |
    mkfs.ext4 -F /dev/vg_data/postgresql_lv
    mkfs.ext4 -F /dev/vg_data/shared_lv
    mkfs.ext4 -F /dev/vg_data/longhorn_lv

- name: üìÅ Crear puntos de montaje y a√±adir a fstab
  raw: |
    mkdir -p /srv/nfs/postgresql
    mkdir -p /srv/nfs/shared
    mkdir -p /mnt/longhorn-disk
    grep -q '/srv/nfs/postgresql' /etc/fstab || echo '/dev/vg_data/postgresql_lv /srv/nfs/postgresql ext4 defaults 0 2' >> /etc/fstab
    grep -q '/srv/nfs/shared'     /etc/fstab || echo '/dev/vg_data/shared_lv     /srv/nfs/shared     ext4 defaults 0 2' >> /etc/fstab
    grep -q '/mnt/longhorn-disk' /etc/fstab || echo '/dev/vg_data/longhorn_lv   /mnt/longhorn-disk ext4 defaults 0 2' >> /etc/fstab

- name: üîÑ Montar vol√∫menes
  raw: mount -a

- name: üß∑ Asignar permisos a puntos de montaje
  raw: |
    chmod 0777 /srv/nfs/postgresql
    chmod 0777 /srv/nfs/shared
    chmod 0777 /mnt/longhorn-disk

- name: üõ†Ô∏è Activar y arrancar servicio NFS
  raw: |
    systemctl enable nfs-server || true
    systemctl start nfs-server || true

- name: üì§ Exportar rutas NFS
  raw: |
    echo '/srv/nfs/postgresql *(rw,sync,no_subtree_check,no_root_squash)' > /etc/exports
    echo '/srv/nfs/shared *(rw,sync,no_subtree_check,no_root_squash)' >> /etc/exports
    exportfs -rv

- name: üè∑Ô∏è Etiquetar nodo Longhorn (opcional)
  raw: |
    kubectl label node storage1.cefaslocalserver.com longhorn-node=true --overwrite || true
  ignore_errors: true