# playbooks\install_longhorn.yml
- name: Instalar Longhorn usando Helm
  hosts: controller
  gather_facts: false
  become: true
  vars:
    longhorn_namespace: "longhorn-system"
    kubeconfig_path: "/home/victory/.kube/config"

  tasks:
    - name: Añadir repositorio Helm de Longhorn
      raw: |
        export KUBECONFIG={{ kubeconfig_path }}
        export PATH=$PATH:/usr/local/bin  # Aseguramos que Helm esté en el PATH
        helm repo add longhorn https://charts.longhorn.io
        helm repo update
      register: helm_repo

    - name: Instalar Longhorn usando Helm
      raw: |
        export KUBECONFIG={{ kubeconfig_path }}
        export PATH=$PATH:/usr/local/bin  # Aseguramos que Helm esté en el PATH
        helm install longhorn longhorn/longhorn --namespace {{ longhorn_namespace }} --create-namespace
      register: longhorn_install
      failed_when: longhorn_install.rc != 0

    - name: Esperar a que los pods de Longhorn estén listos (máx 5 minutos)
      raw: |
        export KUBECONFIG={{ kubeconfig_path }}
        kubectl --namespace {{ longhorn_namespace }} wait --for=condition=Ready pod --all --timeout=300s
      register: wait_longhorn
      failed_when: wait_longhorn.rc != 0

    - name: Mostrar estado final de los pods de Longhorn
      raw: |
        export KUBECONFIG={{ kubeconfig_path }}
        kubectl --namespace {{ longhorn_namespace }} get pods
      register: longhorn_pods

    - name: Imprimir lista de pods Longhorn
      debug:
        var: longhorn_pods.stdout_lines
