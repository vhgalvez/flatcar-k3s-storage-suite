# playbooks/05_copy_token.yml
- name: 📥 Copiar token JWT desde master al controller
  hosts: controller
  become: true
  gather_facts: false

  vars:
    ansible_python_interpreter: /usr/bin/python3
    master_host: "{{ groups['masters'][0] }}"
    remote_token_path: "/tmp/traefik-token.jwt"
    local_token_path: "/home/monitoring/.kube/token.jwt"
    ansible_become_password: "Gdh88K28"

  tasks:
    - name: 📁 Crear carpeta destino
      file:
        path: "{{ local_token_path | dirname }}"
        state: directory
        owner: monitoring
        group: monitoring
        mode: '0755'

    - name: 📥 Copiar token con scp desde el master (sin confirmación SSH)
      raw: |
        scp -o StrictHostKeyChecking=no root@{{ master_host }}:{{ remote_token_path }} {{ local_token_path }}

    - name: 🔐 Ajustar permisos del token
      file:
        path: "{{ local_token_path }}"
        owner: monitoring
        group: monitoring
        mode: '0600'

    - name: 🔒 Validar que el token fue copiado correctamente
      command: cat {{ local_token_path }}
      register: token_check
      changed_when: false
      failed_when: token_check.stdout is not defined or token_check.stdout | length < 100

    - name: ✅ Token copiado correctamente (primeros caracteres)
      debug:
        msg: "🔑 Token JWT: {{ token_check.stdout[:40] }}..."