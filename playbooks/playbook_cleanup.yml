---
# playbook_cleanup.yml
# 🔁 Limpia almacenamiento en nodos storage y workers (solo /dev/vdb).
# ⚠️ Incluye verificación -e "confirm_cleanup=yes" para evitar accidentes.

- name: ♻️ Limpiar configuración de almacenamiento en nodos de storage y workers
  hosts: storage,workers
  become: true
  gather_facts: false

  pre_tasks:
    - name: ✅ Verificación de confirmación de limpieza
      ansible.builtin.assert:
        that:
          - confirm_cleanup | default(false) | bool
        fail_msg: "❌ ERROR: Debe confirmar la limpieza con -e 'confirm_cleanup=yes'"
        success_msg: "🧹 Confirmación recibida. Iniciando limpieza del nodo {{ inventory_hostname }}..."

  tasks:
    - name: 🔌 Desmontar volúmenes montados
      ansible.posix.umount:
        name: "{{ item }}"
      loop:
        - /srv/nfs/postgresql
        - /srv/nfs/shared
        - /mnt/longhorn-disk
      ignore_errors: true

    - name: 🛑 Detener servicio NFS (solo en storage)
      ansible.builtin.raw: |
        systemctl stop nfs-server || rc-service nfs stop || true
        systemctl disable nfs-server || true
      when: "'storage' in group_names"
      changed_when: false
      ignore_errors: true

    - name: 🗑️ Eliminar volúmenes lógicos (solo en storage)
      community.general.lvol:
        vg: vg_storage
        lv: "{{ item }}"
        state: absent
      loop:
        - postgres_lv
        - shared_lv
        - longhorn_lv
      when: "'storage' in group_names"
      ignore_errors: true

    - name: 🧨 Eliminar grupo de volúmenes (solo en storage)
      community.general.lvg:
        vg: vg_storage
        state: absent
      when: "'storage' in group_names"
      ignore_errors: true

    - name: 💣 Borrar firma LVM del disco /dev/vdb1 (solo en storage)
      ansible.builtin.command: pvremove -y /dev/vdb1
      register: pvremove_result
      changed_when: "'wiped' in pvremove_result.stdout or 'successfully' in pvremove_result.stdout"
      when: "'storage' in group_names"
      failed_when: false
      ignore_errors: true

    - name: 🚫 Borrar tabla de partición /dev/vdb
      community.general.parted:
        device: /dev/vdb
        state: absent
        number: 1
      when: "'storage' in group_names"
      ignore_errors: true

    - name: 🧹 Borrar sistema de archivos en /dev/vdb (solo en workers)
      ansible.builtin.raw: |
        wipefs -a /dev/vdb || true
      when: "'workers' in group_names"
      changed_when: false
      ignore_errors: true

    - name: ✅ Mensaje final
      ansible.builtin.debug:
        msg: "✅ Limpieza completada en {{ inventory_hostname }}. Reinicie el nodo si es necesario."