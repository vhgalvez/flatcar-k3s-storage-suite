---
# playbooks\03_cleanup_default_sa.yml
- name: 🧹 3️⃣ Eliminar ServiceAccount 'default' (namespace default)
  hosts: masters
  become: true
  gather_facts: false

  vars:
    ansible_python_interpreter: /bin/false  # ✅ Compatibilidad con Flatcar

  tasks:
    - name: 🔍 Verificar si k3s está disponible
      raw: |
        command -v k3s && k3s kubectl version --client
      register: k3s_check
      failed_when: k3s_check.rc != 0

    - name: 🧹 Eliminar ServiceAccount 'default' si existe
      raw: |
        k3s kubectl delete serviceaccount default --ignore-not-found=true --namespace default
      register: sa_delete

    - name: 📦 Resultado de la eliminación del SA 'default'
      debug:
        var: sa_delete.stdout_lines
