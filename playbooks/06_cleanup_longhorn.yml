# playbooks/03_prepare_storage-workers.yml
---
- name: ğŸ’£ Limpiar completamente /dev/vdb en storage y workers
  hosts: storage,workers
  gather_facts: false
  become: true

  tasks:

    - name: ğŸ” Mostrar si hay montajes activos en /dev/vdb
      raw: mount | grep vdb || true

    - name: ğŸ’£ Desmontar volÃºmenes y esperar
      raw: |
        umount -f /mnt/longhorn-disk 2>/dev/null || true
        umount -f /srv/nfs/postgresql 2>/dev/null || true
        umount -f /srv/nfs/shared 2>/dev/null || true
        sleep 2
      ignore_errors: true

    - name: â³ Esperar a que /dev/vdb ya no estÃ© montado
      raw: |
        for i in $(seq 1 5); do
          mount | grep -q vdb || exit 0
          sleep 1
        done
        exit 1
      register: umount_check
      failed_when: umount_check.rc != 0
      changed_when: false

    - name: âŒ Detener servicios que puedan bloquear el disco (opcional)
      raw: |
        systemctl stop nfs-server || true
        systemctl stop iscsid || true
      when: "'storage' in group_names"

    - name: ğŸ§¹ Eliminar volÃºmenes LVM (si existen)
      raw: |
        lvremove -f /dev/vg_storage/postgres_lv 2>/dev/null || true
        lvremove -f /dev/vg_storage/shared_lv 2>/dev/null || true
        lvremove -f /dev/vg_storage/longhorn_lv 2>/dev/null || true
        sleep 1

    - name: ğŸ§± Eliminar grupo de volÃºmenes
      raw: vgremove -f vg_storage 2>/dev/null || true

    - name: ğŸ’½ Eliminar volumen fÃ­sico
      raw: pvremove -f /dev/vdb1 2>/dev/null || true

    - name: â Eliminar particiÃ³n y limpiar firmas
      raw: |
        parted -s /dev/vdb rm 1 2>/dev/null || true
        wipefs -a /dev/vdb 2>/dev/null || true

    - name: ğŸ§¼ Esperar a que el sistema asiente los cambios
      raw: udevadm settle