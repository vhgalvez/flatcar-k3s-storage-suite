# playbooks\cleanup_longhorn.yml
- name: 🧹 Limpiar namespace, CRDs y finalizadores de Longhorn
  hosts: controller
  become: true
  gather_facts: false

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    longhorn_namespace: "longhorn-system"
    kubectl_bin: "/usr/local/bin/kubectl"
    helm_bin: "/usr/local/bin/helm"

  tasks:

    - name: ❌ Borrar recursos del namespace
      shell: |
        export KUBECONFIG={{ kubeconfig_path }}
        {{ kubectl_bin }} delete all --all -n {{ longhorn_namespace }} --ignore-not-found
        {{ kubectl_bin }} delete pvc --all -n {{ longhorn_namespace }} --ignore-not-found
        {{ kubectl_bin }} delete pv --all --ignore-not-found
        {{ kubectl_bin }} delete deployment,daemonset,pod -n {{ longhorn_namespace }} --all --ignore-not-found
      changed_when: false

    - name: 🧨 Forzar eliminación del namespace si sigue existiendo
      shell: |
        export KUBECONFIG={{ kubeconfig_path }}
        {{ kubectl_bin }} get namespace {{ longhorn_namespace }} &>/dev/null || exit 0
        {{ kubectl_bin }} patch namespace {{ longhorn_namespace }} -p '{"metadata":{"finalizers":[]}}' --type=merge || true
        {{ kubectl_bin }} delete namespace {{ longhorn_namespace }} --ignore-not-found
      changed_when: false

    - name: 💣 Eliminar CRDs de Longhorn
      shell: |
        export KUBECONFIG={{ kubeconfig_path }}
        {{ kubectl_bin }} get crds | grep longhorn.io | awk '{print $1}' | xargs -r {{ kubectl_bin }} delete crd || true
      changed_when: false

    - name: 🧹 Desinstalar Longhorn con Helm (si existe release)
      shell: |
        export KUBECONFIG={{ kubeconfig_path }}
        if {{ helm_bin }} list -n {{ longhorn_namespace }} | grep -q longhorn; then
          {{ helm_bin }} uninstall longhorn -n {{ longhorn_namespace }} || true
        fi
      changed_when: false

    - name: ✅ Verificar que todo fue eliminado
      shell: |
        export KUBECONFIG={{ kubeconfig_path }}
        echo "Pods activos:"
        {{ kubectl_bin }} get pods -A | grep longhorn || echo "✅ Ningún pod de Longhorn activo"
      register: check_result
      changed_when: false

    - name: 🧾 Mostrar resumen
      debug:
        var: check_result.stdout_lines