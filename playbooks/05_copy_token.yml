# playbooks/05_copy_token.yml
---
- name: 📥 Copiar token JWT desde master y guardarlo en controller
  hosts: controller
  become: true
  gather_facts: false

  vars:
    ansible_python_interpreter: /usr/bin/python3  # El controller tiene Python
    master_host: "{{ groups['masters'][0] }}"
    remote_token_path: "/tmp/traefik-token.jwt"
    local_token_path: "/home/monitoring/.kube/token.jwt"

  tasks:

    - name: 📁 Crear carpeta destino
      file:
        path: "{{ local_token_path | dirname }}"
        state: directory
        owner: monitoring
        group: monitoring
        mode: '0755'

    - name: 🔍 Obtener contenido del token generado en el master
      set_fact:
        token_value: "{{ hostvars[master_host]['token_output']['stdout'] | trim }}"

    - name: 📄 Escribir token en archivo local
      copy:
        content: "{{ token_value }}"
        dest: "{{ local_token_path }}"
        owner: monitoring
        group: monitoring
        mode: '0600'

    - name: 🔒 Verificar token copiado
      command: cat {{ local_token_path }}
      register: token_check
      changed_when: false

    - name: 📦 Token copiado al controller
      debug:
        var: token_check.stdout