# playbooks\05_validate_cluster.yml
---
- name: 🚀 5 - Validar la instalación de Longhorn
  hosts: controller
  become: true
  gather_facts: false

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    longhorn_namespace: "longhorn-system"
    kubectl_path: "/usr/local/bin/kubectl"

  tasks:

    - name: 🔍 Comprobar si existe el namespace Longhorn
      shell: "{{ kubectl_path }} get namespace {{ longhorn_namespace }} || true"
      register: ns_check
      changed_when: false

    - name: 🔍 Verificar si hay recursos en el namespace Longhorn
      shell: "{{ kubectl_path }} get all -n {{ longhorn_namespace }} || true"
      register: longhorn_check
      changed_when: false
      when: "'NotFound' not in ns_check.stdout"

    - name: 📊 Mostrar estado de los pods, PVCs y PVs
      shell: |
        echo "📦 Pods:"
        {{ kubectl_path }} get pods -n {{ longhorn_namespace }}

        echo ""
        echo "📁 PVCs:"
        {{ kubectl_path }} get pvc -A

        echo ""
        echo "📦 PVs:"
        {{ kubectl_path }} get pv -A
      register: estado_recursos
      changed_when: false

    - name: 📄 Mostrar recursos detectados si el namespace existe
      debug:
        msg: |
          ⚠️ El namespace '{{ longhorn_namespace }}' contiene recursos activos:
          {{ longhorn_check.stdout }}
      when: "'NotFound' not in ns_check.stdout"