---
# roles/storage_setup/tasks/main.yml

- name: ğŸ›‘ Detener servicio NFS si estÃ¡ activo
  raw: systemctl stop nfs-server || true
  ignore_errors: true

- name: ğŸ’½ Desmontar y limpiar volÃºmenes antiguos si existen
  raw: |
    umount -f /srv/nfs/postgresql || true
    umount -f /srv/nfs/shared || true
    umount -f /mnt/longhorn-disk || true
    lvremove -f /dev/vg_data/postgresql_lv || true
    lvremove -f /dev/vg_data/shared_lv || true
    lvremove -f /dev/vg_data/longhorn_lv || true
    vgremove -f vg_data || true
    wipefs -a /dev/vdb || true
    dd if=/dev/zero of=/dev/vdb bs=1M count=10 || true
    pvremove -ff -y /dev/vdb || true

- name: â• Crear volumen fÃ­sico y grupo de volÃºmenes
  raw: |
    pvcreate /dev/vdb
    vgcreate vg_data /dev/vdb

- name: â• Crear volÃºmenes lÃ³gicos (10G + 10G + 59G)
  raw: |
    lvcreate -L 10G -n postgresql_lv vg_data
    lvcreate -L 10G -n shared_lv vg_data
    lvcreate -L 59G -n longhorn_lv vg_data

- name: ğŸ§± Formatear volÃºmenes con ext4 si no tienen FS
  raw: |
    blkid /dev/vg_data/postgresql_lv || mkfs.ext4 -F /dev/vg_data/postgresql_lv
    blkid /dev/vg_data/shared_lv || mkfs.ext4 -F /dev/vg_data/shared_lv
    blkid /dev/vg_data/longhorn_lv || mkfs.ext4 -F /dev/vg_data/longhorn_lv

- name: ğŸ“ Crear puntos de montaje y entradas fstab
  raw: |
    mkdir -p /srv/nfs/postgresql /srv/nfs/shared /mnt/longhorn-disk
    grep -q 'postgresql' /etc/fstab || echo '/dev/vg_data/postgresql_lv /srv/nfs/postgresql ext4 defaults 0 2' >> /etc/fstab
    grep -q 'shared'     /etc/fstab || echo '/dev/vg_data/shared_lv     /srv/nfs/shared     ext4 defaults 0 2' >> /etc/fstab
    grep -q 'longhorn'   /etc/fstab || echo '/dev/vg_data/longhorn_lv   /mnt/longhorn-disk ext4 defaults 0 2' >> /etc/fstab

- name: ğŸ”„ Montar volÃºmenes
  raw: mount -a

- name: ğŸ§· Asignar permisos 0777
  raw: |
    chmod 0777 /srv/nfs/postgresql
    chmod 0777 /srv/nfs/shared
    chmod 0777 /mnt/longhorn-disk

- name: ğŸ› ï¸ Activar y arrancar NFS server
  raw: |
    systemctl enable --now nfs-server || true

- name: ğŸ“¤ Exportar rutas NFS
  raw: |
    echo '/srv/nfs/postgresql *(rw,sync,no_subtree_check,no_root_squash)' > /etc/exports
    echo '/srv/nfs/shared *(rw,sync,no_subtree_check,no_root_squash)' >> /etc/exports
    exportfs -rv

- name: ğŸ·ï¸ Etiquetar nodo para Longhorn (opcional)
  raw: |
    kubectl label node storage1.cefaslocalserver.com longhorn-node=true --overwrite || true
  ignore_errors: true