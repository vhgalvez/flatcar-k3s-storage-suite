- name: ♻️ Limpiar configuración de almacenamiento en nodos de storage y workers
  hosts: storage,workers,controller
  become: true
  gather_facts: false

  pre_tasks:
    - name: ✅ Verificación de confirmación de limpieza
      ansible.builtin.assert:
        that:
          - confirm_cleanup | default(false) | bool
        fail_msg: "❌ ERROR: Debe confirmar la limpieza con -e 'confirm_cleanup=yes'"
        success_msg: "🧹 Confirmación recibida. Iniciando limpieza del nodo {{ inventory_hostname }}..."

  tasks:

    # -----------------------
    # 1️⃣ Limpieza en controller
    # -----------------------
    - name: 🗑️ Eliminar release de Helm de Longhorn (si existe)
      ansible.builtin.raw: |
        helm uninstall longhorn --namespace longhorn-system || true
        kubectl delete namespace longhorn-system --ignore-not-found || true
      when: "'controller' in group_names"

    - name: 🧹 Limpiar secretos de Helm
      ansible.builtin.raw: |
        kubectl delete secret -n longhorn-system -l "owner=helm,name=longhorn" || true
      when: "'controller' in group_names"

    - name: 🧨 Eliminar CustomResourceDefinitions de Longhorn
      ansible.builtin.raw: |
        kubectl delete crd -l app.kubernetes.io/name=longhorn || true
      when: "'controller' in group_names"

    # -----------------------
    # 2️⃣ Limpieza en storage
    # -----------------------
    - name: 🔌 Desmontar volúmenes montados
      ansible.builtin.raw: |
        umount -f /srv/nfs/postgresql || true
        umount -f /srv/nfs/shared || true
        umount -f /mnt/longhorn-disk || true
      changed_when: false
      ignore_errors: true

    - name: 🛑 Detener servicio NFS (solo en storage)
      ansible.builtin.raw: |
        systemctl stop nfs-server || rc-service nfs stop || true
        systemctl disable nfs-server || true
      when: "'storage' in group_names"

    - name: 🗑️ Eliminar volúmenes lógicos
      ansible.builtin.raw: |
        lvremove -y /dev/vg_storage/postgres_lv || true
        lvremove -y /dev/vg_storage/shared_lv || true
        lvremove -y /dev/vg_storage/longhorn_lv || true
      when: "'storage' in group_names"

    - name: 🧨 Eliminar grupo de volúmenes
      ansible.builtin.raw: |
        vgremove -y vg_storage || true
      when: "'storage' in group_names"

    - name: 💣 Borrar firma LVM del disco /dev/vdb1
      ansible.builtin.raw: |
        pvremove -y /dev/vdb1 || true
      when: "'storage' in group_names"

    - name: 🚫 Borrar tabla de partición /dev/vdb
      ansible.builtin.raw: |
        parted /dev/vdb rm 1 || true
      when: "'storage' in group_names"

    # -----------------------
    # 3️⃣ Limpieza en workers
    # -----------------------
    - name: 🧹 Borrar sistema de archivos en /dev/vdb
      ansible.builtin.raw: |
        wipefs -a /dev/vdb || true
      when: "'workers' in group_names"

    - name: ✅ Mensaje final
      ansible.builtin.debug:
        msg: "✅ Limpieza completada en {{ inventory_hostname }}. Reinicie el nodo si es necesario."