---
- name: â™»ï¸ Limpieza completa de Longhorn en nodos controller, storage y workers
  hosts: controller,storage,workers
  become: true
  gather_facts: false

  vars:
    kubeconfig_path: "/home/victory/.kube/config"

  pre_tasks:
    - name: âœ… ConfirmaciÃ³n requerida
      assert:
        that:
          - confirm_cleanup | default(false) | bool
        fail_msg: "âŒ ERROR: Debe confirmar con -e 'confirm_cleanup=yes'"
        success_msg: "ğŸ§¹ ConfirmaciÃ³n recibida en {{ inventory_hostname }}"

  tasks:

    # CONTROLLER
    - name: ğŸ”§ Instalar jq (requerido para eliminar finalizers)
      raw: |
        which jq || (apt-get update && apt-get install -y jq) || (yum install -y jq)
      when: "'controller' in group_names"

    - name: ğŸ—‘ï¸ Eliminar Helm release de Longhorn
      raw: |
        export PATH=$PATH:/usr/local/bin
        export KUBECONFIG={{ kubeconfig_path }}
        helm uninstall longhorn -n longhorn-system || true
      when: "'controller' in group_names"

    - name: ğŸ§¨ Eliminar TODOS los recursos del namespace
      raw: |
        export KUBECONFIG={{ kubeconfig_path }}
        kubectl delete all,sa,configmaps,secrets,crd,volumes,pvc,sc \
          --all -n longhorn-system --ignore-not-found --wait=true || true
      when: "'controller' in group_names"

    - name: ğŸš« Forzar eliminaciÃ³n del namespace con finalizers (si queda bloqueado)
      raw: |
        export KUBECONFIG={{ kubeconfig_path }}
        kubectl get namespace longhorn-system -o json | \
        jq 'del(.spec.finalizers)' | \
        kubectl replace --raw "/api/v1/namespaces/longhorn-system/finalize" -f - || true
      when: "'controller' in group_names"

    - name: â³ Espera breve para asegurar eliminaciÃ³n completa
      pause:
        seconds: 15
      when: "'controller' in group_names"

    - name: ğŸ” Verificar que el namespace y recursos fueron eliminados
      raw: |
        export KUBECONFIG={{ kubeconfig_path }}
        echo "ğŸ” Verificando namespace..."
        kubectl get ns longhorn-system || echo "âœ… Namespace eliminado"
        echo "ğŸ” Verificando CRDs..."
        kubectl get crd | grep longhorn || echo "âœ… CRDs eliminados"
        echo "ğŸ” Verificando recursos..."
        kubectl get all -A | grep longhorn || echo "âœ… Sin recursos activos"
      register: longhorn_cleanup_status
      when: "'controller' in group_names"

    - name: ğŸ“‹ Resultado de la limpieza en controller
      debug:
        var: longhorn_cleanup_status.stdout_lines
      when: "'controller' in group_names"

    # STORAGE
    - name: ğŸ”Œ Desmontar volÃºmenes NFS y Longhorn
      raw: |
        umount -f /srv/nfs/postgresql || true
        umount -f /srv/nfs/shared || true
        umount -f /mnt/longhorn-disk || true
      ignore_errors: true
      when: "'storage' in group_names"

    - name: ğŸ›‘ Detener y deshabilitar NFS
      raw: |
        systemctl stop nfs-server || rc-service nfs stop || true
        systemctl disable nfs-server || true
      when: "'storage' in group_names"

    - name: ğŸ—‘ï¸ Eliminar volÃºmenes lÃ³gicos
      raw: |
        lvremove -y /dev/vg_storage/postgres_lv || true
        lvremove -y /dev/vg_storage/shared_lv || true
        lvremove -y /dev/vg_storage/longhorn_lv || true
      when: "'storage' in group_names"

    - name: ğŸ§¨ Eliminar grupo de volÃºmenes
      raw: vgremove -y vg_storage || true
      when: "'storage' in group_names"

    - name: ğŸ’£ Borrar firma LVM y tabla de particiÃ³n
      raw: |
        pvremove -y /dev/vdb1 || true
        parted /dev/vdb rm 1 || true
      when: "'storage' in group_names"

    # WORKERS
    - name: ğŸ§¹ Borrar sistema de archivos en /dev/vdb
      raw: wipefs -a /dev/vdb || true
      when: "'workers' in group_names"

    # FINAL
    - name: âœ… ConfirmaciÃ³n final
      debug:
        msg: "âœ… Limpieza finalizada correctamente en {{ inventory_hostname }}. Puedes reiniciar el nodo si lo deseas."