# playbook/02_setup_kubeconfig.yml
- name: Configurar kubeconfig local desde nodo master
  hosts: controller
  gather_facts: false
  become: true

  vars:
    kubeconfig_path: "/home/monitoring/.kube/config"
    master_node: "10.17.4.21"
    ssh_key_path: "/root/.ssh/cluster_k3s/shared/id_rsa_shared_cluster"
    vip_kubernetes: "10.17.5.10"
    ssh_user: "core"
    token: "<YOUR_K8S_TOKEN>"  # Asegúrate de reemplazar esto con el token adecuado

  tasks:
    - name: 📁 Crear carpeta ~/.kube si no existe
      file:
        path: "{{ kubeconfig_path | dirname }}"
        state: directory
        owner: monitoring
        group: monitoring
        mode: '0755'

    - name: 📥 Descargar kubeconfig desde master1
      raw: >
        scp -i {{ ssh_key_path }} -o StrictHostKeyChecking=no {{ ssh_user }}@{{ master_node }}:/etc/rancher/k3s/k3s.yaml {{ kubeconfig_path }}
      become: false

    - name: 🔁 Reemplazar IP localhost por VIP en kubeconfig
      replace:
        path: "{{ kubeconfig_path }}"
        regexp: '127\.0\.0\.1'
        replace: "{{ vip_kubernetes }}"

    - name: ❌ Eliminar línea certificate-authority-data
      lineinfile:
        path: "{{ kubeconfig_path }}"
        regexp: '^\s*certificate-authority-data:'
        state: absent

    - name: ⚠️ Añadir 'insecure-skip-tls-verify'
      replace:
        path: "{{ kubeconfig_path }}"
        regexp: '(^\s*server: https://{{ vip_kubernetes }}:6443)'
        replace: '\1\n    insecure-skip-tls-verify: true'

    - name: 🔑 Añadir el token de autenticación en kubeconfig
      lineinfile:
        path: "{{ kubeconfig_path }}"
        regexp: '^\s*token:'
        line: 'token: {{ token }}'
        state: present

    - name: 🔐 Ajustar permisos kubeconfig
      file:
        path: "{{ kubeconfig_path }}"
        owner: monitoring
        group: monitoring
        mode: '0600'

    - name: 🧪 Verificar acceso a Kubernetes
      command: /usr/local/bin/kubectl get nodes
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: nodes_output
      failed_when: nodes_output.rc != 0
      changed_when: false

    - name: 📊 Mostrar nodos
      debug:
        msg: "{{ nodes_output.stdout }}"