---
# playbooks/playbook_cleanup.yml
# ğŸ” Limpia almacenamiento en nodos storage y workers (solo /dev/vdb).
# âš ï¸ Incluye verificaciÃ³n -e "confirm_cleanup=yes" para evitar accidentes.

- name: â™»ï¸ Limpiar configuraciÃ³n de almacenamiento en nodos de storage y workers
  hosts: storage,workers
  become: true
  gather_facts: false

  pre_tasks:
    - name: âœ… VerificaciÃ³n de confirmaciÃ³n de limpieza
      ansible.builtin.assert:
        that:
          - confirm_cleanup | default(false) | bool
        fail_msg: "âŒ ERROR: Debe confirmar la limpieza con -e 'confirm_cleanup=yes'"
        success_msg: "ğŸ§¹ ConfirmaciÃ³n recibida. Iniciando limpieza del nodo {{ inventory_hostname }}..."

  tasks:
    - name: ğŸ”Œ Desmontar volÃºmenes montados
      ansible.builtin.raw: |
        umount -f /srv/nfs/postgresql 2>/dev/null || true
        umount -f /srv/nfs/shared 2>/dev/null || true
        umount -f /mnt/longhorn-disk 2>/dev/null || true
      changed_when: false
      ignore_errors: true

    - name: ğŸ›‘ Detener servicio NFS (solo en storage)
      ansible.builtin.raw: |
        systemctl stop nfs-server || rc-service nfs stop || true
        systemctl disable nfs-server || true
      when: "'storage' in group_names"
      changed_when: false
      ignore_errors: true

    - name: ğŸ—‘ï¸ Eliminar volÃºmenes lÃ³gicos (solo en storage)
      ansible.builtin.raw: |
        lvremove -y /dev/vg_storage/postgres_lv || true
        lvremove -y /dev/vg_storage/shared_lv || true
        lvremove -y /dev/vg_storage/longhorn_lv || true
      when: "'storage' in group_names"
      changed_when: false
      ignore_errors: true

    - name: ğŸ§¨ Eliminar grupo de volÃºmenes (solo en storage)
      ansible.builtin.raw: |
        vgremove -y vg_storage || true
      when: "'storage' in group_names"
      changed_when: false
      ignore_errors: true

    - name: ğŸ’£ Borrar firma LVM del disco /dev/vdb1 (solo en storage)
      ansible.builtin.raw: |
        pvremove -y /dev/vdb1 || true
      when: "'storage' in group_names"
      changed_when: false
      ignore_errors: true

    - name: ğŸš« Borrar tabla de particiÃ³n /dev/vdb (solo en storage)
      ansible.builtin.raw: |
        parted /dev/vdb rm 1 || true
      when: "'storage' in group_names"
      changed_when: false
      ignore_errors: true

    - name: ğŸ§¹ Borrar sistema de archivos en /dev/vdb (solo en workers)
      ansible.builtin.raw: |
        wipefs -a /dev/vdb || true
      when: "'workers' in group_names"
      changed_when: false
      ignore_errors: true

    # ğŸ§¹ Limpiar recursos de Longhorn (tanto en storage como en workers)
    - name: ğŸš« Eliminar recursos de Longhorn (nodos storage y workers)
      ansible.builtin.raw: |
        kubectl delete pvc --all --namespace longhorn-system --grace-period=0 --force || true
        kubectl delete pv --all --namespace longhorn-system --grace-period=0 --force || true
        kubectl delete pod --all --namespace longhorn-system --grace-period=0 --force || true
        kubectl delete deployment longhorn --namespace longhorn-system --grace-period=0 --force || true
        kubectl delete statefulset longhorn --namespace longhorn-system --grace-period=0 --force || true
        kubectl delete priorityclass longhorn-critical --namespace longhorn-system --grace-period=0 --force || true
        kubectl delete serviceaccount longhorn-service-account --namespace longhorn-system --grace-period=0 --force || true
        kubectl delete secret longhorn-secret --namespace longhorn-system --grace-period=0 --force || true
      changed_when: false
      ignore_errors: true

    - name: âœ… Mensaje final
      ansible.builtin.debug:
        msg: "âœ… Limpieza completada en {{ inventory_hostname }}. Reinicie el nodo si es necesario."