# playbooks/05_ingress-longhorn-internal.yml
---
- name: ğŸšª 5 - Exponer Longhorn Dashboard con IngressRoute Interno
  hosts: localhost
  become: true
  gather_facts: false

  vars:
    longhorn_namespace: longhorn-system
    dashboard_auth_secret: longhorn-dashboard-auth
    domain: longhorn.socialdevs.site
    kubeconfig_path: "/home/victory/.kube/config"
    kubectl_bin: "/usr/local/bin/kubectl"

  tasks:

    - name: âš ï¸ Verificar si ya existe el Secret de autenticaciÃ³n
      shell: |
        KUBECONFIG={{ kubeconfig_path }} {{ kubectl_bin }} get secret {{ dashboard_auth_secret }} -n {{ longhorn_namespace }} --ignore-not-found
      register: auth_secret_check
      changed_when: false

    - name: âŒ Abortamos si ya existe un Secret con ese nombre
      fail:
        msg: |
          âš ï¸ El Secret '{{ dashboard_auth_secret }}' ya existe en el namespace '{{ longhorn_namespace }}'.
          Si deseas regenerarlo, primero elimÃ­nalo manualmente con:
            {{ kubectl_bin }} delete secret {{ dashboard_auth_secret }} -n {{ longhorn_namespace }}
      when: auth_secret_check.stdout is search("Name:.*{{ dashboard_auth_secret }}")

    - name: ğŸ“ Renderizar Middleware de autenticaciÃ³n
      template:
        src: templates/longhorn/middleware-auth.yaml.j2
        dest: /tmp/longhorn-middleware-auth.yaml
      vars:
        secret_name: "{{ dashboard_auth_secret }}"
        namespace: "{{ longhorn_namespace }}"

    - name: ğŸ“ Renderizar IngressRoute interno de Longhorn
      template:
        src: templates/longhorn/ingressroute-internal.yaml.j2
        dest: /tmp/longhorn-ingressroute-internal.yaml
      vars:
        domain: "{{ domain }}"
        middleware_name: "{{ dashboard_auth_secret }}"
        namespace: "{{ longhorn_namespace }}"

    - name: ğŸš€ Aplicar Middleware (auth)
      shell: |
        KUBECONFIG={{ kubeconfig_path }} {{ kubectl_bin }} apply -f /tmp/longhorn-middleware-auth.yaml
      changed_when: true

    - name: ğŸš€ Aplicar IngressRoute (Interno)
      shell: |
        KUBECONFIG={{ kubeconfig_path }} {{ kubectl_bin }} apply -f /tmp/longhorn-ingressroute-internal.yaml
      changed_when: true