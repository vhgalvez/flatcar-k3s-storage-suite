---
# playbooks\02_prepare_storage.yml
- name: 2️⃣ Preparar nodo de almacenamiento con LVM + NFS
  hosts: storage
  become: true
  gather_facts: false

  tasks:

    - name: 📀 Verificar existencia del disco /dev/vdb
      raw: test -b /dev/vdb
      register: disk_check
      failed_when: disk_check.rc != 0
      changed_when: false

    - name: 🧹 Crear tabla de particiones GPT
      raw: parted -s /dev/vdb mklabel gpt

    - name: 📏 Crear partición primaria 100%
      raw: parted -s /dev/vdb mkpart primary 0% 100%

    - name: ⏳ Esperar a que /dev/vdb1 aparezca
      raw: |
        for i in $(seq 1 5); do
          test -b /dev/vdb1 && exit 0
          sleep 1
        done
        exit 1
      register: wait_partition
      failed_when: wait_partition.rc != 0

    - name: 💽 Crear volumen físico LVM
      raw: pvcreate -ff -y /dev/vdb1

    - name: 🧱 Crear grupo de volúmenes
      raw: vgcreate vg_storage /dev/vdb1

    - name: 📦 Crear volumen lógico para PostgreSQL (20 GB)
      raw: lvcreate -y -L 20G -n postgres_lv vg_storage

    - name: 📦 Crear volumen lógico para datos compartidos (20 GB)
      raw: lvcreate -y -L 20G -n shared_lv vg_storage

    - name: 📦 Crear volumen lógico para Longhorn (resto)
      raw: lvcreate -y -l 100%FREE -n longhorn_lv vg_storage

    - name: 🧹 Formatear postgres_lv como ext4
      raw: mkfs.ext4 -F /dev/vg_storage/postgres_lv

    - name: 🧹 Formatear shared_lv como ext4
      raw: mkfs.ext4 -F /dev/vg_storage/shared_lv

    - name: 🧹 Formatear longhorn_lv como ext4
      raw: mkfs.ext4 -F /dev/vg_storage/longhorn_lv

    - name: 📁 Crear directorios de montaje
      raw: mkdir -p /srv/nfs/postgresql /srv/nfs/shared /mnt/longhorn-disk

    - name: 🔗 Montar postgres_lv
      raw: mount /dev/vg_storage/postgres_lv /srv/nfs/postgresql

    - name: 🔗 Montar shared_lv
      raw: mount /dev/vg_storage/shared_lv /srv/nfs/shared

    - name: 🔗 Montar longhorn_lv
      raw: mount /dev/vg_storage/longhorn_lv /mnt/longhorn-disk

    - name: 📦 Instalar servidor NFS (distribución agnóstica)
      raw: |
        which exportfs >/dev/null 2>&1 || \
        (apk add nfs-utils || yum install -y nfs-utils || apt-get install -y nfs-kernel-server)

    - name: 📝 Configurar exports NFS
      raw: |
        echo "/srv/nfs/postgresql *(rw,sync,no_subtree_check,no_root_squash)" > /etc/exports
        echo "/srv/nfs/shared *(rw,sync,no_subtree_check,no_root_squash)" >> /etc/exports

    - name: 🔄 Reiniciar servicio NFS
      raw: |
        (systemctl enable nfs-server && systemctl restart nfs-server) || \
        (rc-service nfs restart)

    - name: ✅ Validar montaje final
      raw: df -h | grep -E "/srv/nfs/postgresql|/srv/nfs/shared|/mnt/longhorn-disk"
      register: mount_check
      failed_when: mount_check.rc != 0

    - name: 🟢 Mostrar estado de montajes
      debug:
        var: mount_check.stdout_lines