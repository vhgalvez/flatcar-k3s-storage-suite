# roles/longhorn_worker/tasks/main.yml
---

- name: ğŸ§½ Verificar si /mnt/longhorn-disk ya estÃ¡ montado
  shell: mount | grep /mnt/longhorn-disk || true
  register: vdb_mount_check
  changed_when: false

- name: ğŸ§½ Formatear disco adicional (/dev/vdb) para Longhorn (si no estÃ¡ montado)
  raw: mkfs.ext4 -F /dev/vdb
  when: vdb_mount_check.stdout == ""

- name: ğŸ“ Crear punto de montaje para Longhorn
  raw: mkdir -p /mnt/longhorn-disk

- name: ğŸ“„ AÃ±adir punto de montaje a /etc/fstab y montar volumen
  raw: |
    grep -q '/mnt/longhorn-disk' /etc/fstab || echo '/dev/vdb /mnt/longhorn-disk ext4 defaults 0 2' >> /etc/fstab
    mount -a

- name: ğŸ›¡ï¸ Asignar permisos a la ruta /mnt/longhorn-disk
  raw: chmod 0777 /mnt/longhorn-disk

- name: ğŸ·ï¸ Etiquetar nodo como longhorn-node
  raw: |
    nodename=$(hostname)
    kubectl label node "$nodename" longhorn-node=true --overwrite || true
  ignore_errors: true
