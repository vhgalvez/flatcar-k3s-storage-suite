# playbooks\05_validate_cluster.yml
---
- name: ğŸš€ 5 - Validar la instalaciÃ³n de Longhorn
  hosts: controller
  become: true
  gather_facts: false

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    longhorn_namespace: "longhorn-system"

  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH }}"
    KUBECONFIG: "{{ kubeconfig_path }}"

  pre_tasks:

    - name: ğŸ” Comprobar si existe el namespace Longhorn
      shell: kubectl get namespace {{ longhorn_namespace }} || true
      register: ns_check
      changed_when: false

    - name: ğŸ” Verificar si hay recursos en el namespace Longhorn
      raw: kubectl get all -n {{ longhorn_namespace }} || true
      register: longhorn_check
      changed_when: false
      when: "'NotFound' not in ns_check.stdout"

    - name: âš ï¸ Abortamos si hay residuos en el namespace existente
      fail:
        msg: |
          âš ï¸ El namespace '{{ longhorn_namespace }}' contiene recursos de una instalaciÃ³n anterior.
          ğŸ§¹ Ejecuta: ansible-playbook playbooks/08_cleanup_longhorn.yml -e "confirm_cleanup=yes"
          Recursos detectados:
          {{ longhorn_check.stdout }}
      when:
        - "'NotFound' not in ns_check.stdout"
        - "'No resources found' not in longhorn_check.stdout"

  tasks:

    - name: ğŸ“Š Mostrar estado de los pods, PVCs y PVs
      raw: |
        echo "ğŸ“¦ Pods:"
        kubectl get pods -n {{ longhorn_namespace }}

        echo ""
        echo "ğŸ“ PVCs:"
        kubectl get pvc -A

        echo ""
        echo "ğŸ“¦ PVs:"
        kubectl get pv -A