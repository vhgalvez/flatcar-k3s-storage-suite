---
# roles/longhorn_worker/tasks/main.yml
# Este rol prepara el disco adicional (/dev/vdb) en los nodos destinados a Longhorn.
# Es compatible con Flatcar Linux (sin Python), usando comandos raw.

- name: ğŸ§ª Verificar existencia del disco /dev/vdb
  raw: test -b /dev/vdb
  register: disk_check
  failed_when: disk_check.rc != 0
  changed_when: false

- name: ğŸ§ª Verificar si /dev/vdb tiene particiones
  raw: lsblk -n /dev/vdb | wc -l
  register: vdb_parts
  changed_when: false

- name: ğŸ§ª Verificar si /dev/vdb tiene sistema de archivos
  raw: blkid -o value -s TYPE /dev/vdb || true
  register: fs_check
  changed_when: false
  failed_when: false

- name: ğŸ“¦ Formatear /dev/vdb si estÃ¡ vacÃ­o (sin particiones, sin FS)
  raw: mkfs.ext4 /dev/vdb
  when:
    - vdb_parts.stdout|int <= 1
    - fs_check.stdout == ""

- name: ğŸ“ Crear punto de montaje /mnt/longhorn-disk
  raw: mkdir -p /mnt/longhorn-disk
  changed_when: false

- name: ğŸ”— AÃ±adir a /etc/fstab
  raw: grep -q "/mnt/longhorn-disk" /etc/fstab || echo "/dev/vdb /mnt/longhorn-disk ext4 defaults 0 0" >> /etc/fstab
  changed_when: false

- name: ğŸ“‚ Montar disco /dev/vdb en /mnt/longhorn-disk
  raw: mount /mnt/longhorn-disk
  changed_when: false