# playbooks/01_prepare_nodes.yml
- name: 1️⃣ Instalar herramientas necesarias en el nodo controlador
  hosts: controller
  become: true
  gather_facts: true

  vars:
    kubectl_version: "v1.29.0"
    helm_version: "v3.14.0"
    kubectl_path: "/usr/local/bin/kubectl"
    helm_bin: "/usr/local/bin/helm"
    helm_install_path: "/tmp/helm_install"
    kubeconfig_path: "/home/victory/.kube/config"
    token_path: "/home/victory/.kube/token.jwt"
    vip_kubernetes: "10.17.5.10"

  tasks:

    - name: 📦 Instalar paquetes base (pip, git, curl)
      package:
        name:
          - python3-pip
          - git
          - curl
        state: present

    - name: 🧪 Instalar biblioteca Python para Kubernetes
      pip:
        name: kubernetes

    - name: 📥 Descargar kubectl {{ kubectl_version }}
      get_url:
        url: "https://dl.k8s.io/release/{{ kubectl_version }}/bin/linux/amd64/kubectl"
        dest: /tmp/kubectl
        mode: '0755'

    - name: ✅ Mover kubectl a {{ kubectl_path }}
      copy:
        src: /tmp/kubectl
        dest: "{{ kubectl_path }}"
        remote_src: yes
        mode: '0755'

    - name: 🔍 Verificar instalación de kubectl
      command: "{{ kubectl_path }} version --client"
      register: kubectl_output
      ignore_errors: true

    - name: 📊 Mostrar salida de kubectl
      debug:
        msg: "{{ kubectl_output.stdout | default('kubectl no disponible') }}"

    - name: 📁 Crear directorio temporal para Helm
      file:
        path: "{{ helm_install_path }}"
        state: directory

    - name: 📥 Descargar Helm {{ helm_version }}
      get_url:
        url: "https://get.helm.sh/helm-{{ helm_version }}-linux-amd64.tar.gz"
        dest: "{{ helm_install_path }}/helm.tar.gz"

    - name: 📦 Extraer Helm
      unarchive:
        src: "{{ helm_install_path }}/helm.tar.gz"
        dest: "{{ helm_install_path }}"
        remote_src: yes

    - name: 🗂 Verificar existencia del binario Helm
      stat:
        path: "{{ helm_install_path }}/linux-amd64/helm"
      register: helm_bin_check

    - name: ✅ Mover Helm a {{ helm_bin }}
      copy:
        src: "{{ helm_install_path }}/linux-amd64/helm"
        dest: "{{ helm_bin }}"
        mode: '0755'
        remote_src: yes
      when: helm_bin_check.stat.exists

    - name: 🧪 Verificar versión de Helm
      command: "{{ helm_bin }} version"
      register: helm_output

    - name: 📊 Mostrar salida de Helm
      debug:
        msg: "{{ helm_output.stdout | default('Helm no disponible') }}"

    - name: 🧹 Limpiar archivos temporales de Helm
      file:
        path: "{{ helm_install_path }}"
        state: absent

    # 🔐 Configurar KUBECONFIG con autenticación por token

    - name: 📄 Verificar si existe el kubeconfig
      stat:
        path: "{{ kubeconfig_path }}"
      register: kubeconfig_stat

    - name: 📁 Crear carpeta .kube si no existe
      file:
        path: "{{ kubeconfig_path | dirname }}"
        state: directory
        mode: '0700'
      when: not kubeconfig_stat.stat.exists

    - name: 📄 Crear archivo kubeconfig si no existe
      copy:
        dest: "{{ kubeconfig_path }}"
        content: |
          apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              server: https://{{ vip_kubernetes }}:6443
              insecure-skip-tls-verify: true
            name: default
          contexts:
          - context:
              cluster: default
              user: default
            name: default
          current-context: default
          users: []
        mode: '0600'
      when: not kubeconfig_stat.stat.exists

    - name: 🧹 Eliminar líneas antiguas de certificados y tokens
      lineinfile:
        path: "{{ kubeconfig_path }}"
        regexp: '^\s*(client-certificate|client-key|token):'
        state: absent

    - name: 🛠 Asegurar configuración del cluster con VIP
      blockinfile:
        path: "{{ kubeconfig_path }}"
        block: |
          clusters:
          - cluster:
              server: https://{{ vip_kubernetes }}:6443
              insecure-skip-tls-verify: true
            name: default
        marker: "# {mark} ANSIBLE MANAGED CLUSTER CONFIG"
        insertafter: '^apiVersion:'

    - name: 🔐 Insertar o reemplazar token JWT
      blockinfile:
        path: "{{ kubeconfig_path }}"
        marker: "# {mark} ANSIBLE MANAGED TOKEN"
        insertafter: '^users:'
        block: |
          - name: default
            user:
              token: "{{ lookup('file', token_path) }}"