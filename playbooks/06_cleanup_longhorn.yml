---
# playbooks/03_prepare_storage-workers.yml
- name: 3 - Preparar almacenamiento en nodos storage y workers
  hosts: storage,workers
  gather_facts: false
  become: true

  tasks:

    # === LIMPIEZA COMPLETA (STORAGE) ===
    - name: ğŸ’£ Desmontar y limpiar volÃºmenes antiguos (solo storage)
      raw: |
        umount -f /srv/nfs/postgresql 2>/dev/null || true
        umount -f /srv/nfs/shared 2>/dev/null || true
        umount -f /mnt/longhorn-disk 2>/dev/null || true
        lvremove -f vg_storage/postgres_lv 2>/dev/null || true
        lvremove -f vg_storage/shared_lv 2>/dev/null || true
        lvremove -f vg_storage/longhorn_lv 2>/dev/null || true
        vgremove -f vg_storage 2>/dev/null || true
        pvremove -f /dev/vdb1 2>/dev/null || true
        wipefs -a /dev/vdb 2>/dev/null || true
      when: "'storage' in group_names"

    # === LIMPIEZA (WORKERS) ===
    - name: ğŸ’£ Desmontar y limpiar disco en workers
      raw: |
        umount -f /mnt/longhorn-disk 2>/dev/null || true
        wipefs -a /dev/vdb 2>/dev/null || true
      when: "'workers' in group_names"

    - name: ğŸ“€ Verificar existencia del disco /dev/vdb
      raw: test -b /dev/vdb
      register: disk_check
      failed_when: disk_check.rc != 0
      changed_when: false

    # === STORAGE ONLY ===
    - name: ğŸ§¹ Crear tabla de particiones GPT
      raw: parted -s /dev/vdb mklabel gpt
      when: "'storage' in group_names"

    - name: ğŸ“ Crear particiÃ³n primaria 100%
      raw: parted -s /dev/vdb mkpart primary 0% 100%
      when: "'storage' in group_names"

    - name: â³ Esperar a que /dev/vdb1 aparezca
      raw: |
        for i in $(seq 1 5); do
          test -b /dev/vdb1 && exit 0
          sleep 1
        done
        exit 1
      register: wait_partition
      failed_when: wait_partition.rc != 0
      when: "'storage' in group_names"

    - name: ğŸ’½ Crear volumen fÃ­sico LVM
      raw: pvcreate -ff -y /dev/vdb1
      when: "'storage' in group_names"

    - name: ğŸ§± Crear grupo de volÃºmenes
      raw: vgcreate vg_storage /dev/vdb1
      when: "'storage' in group_names"

    - name: ğŸ“¦ Crear volÃºmenes lÃ³gicos
      raw: |
        lvcreate -y -L 20G -n postgres_lv vg_storage
        lvcreate -y -L 20G -n shared_lv vg_storage
        lvcreate -y -l 100%FREE -n longhorn_lv vg_storage
      when: "'storage' in group_names"

    - name: ğŸ§¹ Formatear volÃºmenes como ext4
      raw: |
        mkfs.ext4 -F /dev/vg_storage/postgres_lv
        mkfs.ext4 -F /dev/vg_storage/shared_lv
        mkfs.ext4 -F /dev/vg_storage/longhorn_lv
      when: "'storage' in group_names"

    - name: ğŸ“ Crear directorios de montaje
      raw: mkdir -p /srv/nfs/postgresql /srv/nfs/shared /mnt/longhorn-disk
      when: "'storage' in group_names"

    - name: ğŸ”— Montar volÃºmenes
      raw: |
        mount /dev/vg_storage/postgres_lv /srv/nfs/postgresql
        mount /dev/vg_storage/shared_lv /srv/nfs/shared
        mount /dev/vg_storage/longhorn_lv /mnt/longhorn-disk
      when: "'storage' in group_names"

    - name: ğŸ“¦ Instalar servidor NFS
      raw: |
        which exportfs >/dev/null 2>&1 || \
        (apk add nfs-utils || yum install -y nfs-utils || apt-get install -y nfs-kernel-server)
      when: "'storage' in group_names"

    - name: ğŸ“ Configurar /etc/exports
      raw: |
        grep -q "/srv/nfs/postgresql" /etc/exports || \
        echo "/srv/nfs/postgresql *(rw,sync,no_subtree_check,no_root_squash)" >> /etc/exports
        grep -q "/srv/nfs/shared" /etc/exports || \
        echo "/srv/nfs/shared *(rw,sync,no_subtree_check,no_root_squash)" >> /etc/exports
      when: "'storage' in group_names"

    - name: ğŸ”„ Habilitar y reiniciar NFS
      raw: |
        (systemctl enable nfs-server && systemctl restart nfs-server) || rc-service nfs restart || true
      when: "'storage' in group_names"

    # === WORKERS ONLY ===
    - name: ğŸ’½ Formatear /dev/vdb como ext4
      raw: mkfs.ext4 -F /dev/vdb
      when: "'workers' in group_names"

    - name: ğŸ“ Crear punto de montaje
      raw: mkdir -p /mnt/longhorn-disk
      when: "'workers' in group_names"

    - name: ğŸ”— Montar /dev/vdb
      raw: mount /dev/vdb /mnt/longhorn-disk
      when: "'workers' in group_names"

    # === VALIDACIÃ“N FINAL ===
    - name: âœ… Validar montaje final
      raw: df -h | grep -E "/srv/nfs/postgresql|/srv/nfs/shared|/mnt/longhorn-disk"
      register: mount_check
      failed_when: mount_check.rc != 0

    - name: ğŸŸ¢ Mostrar estado de montajes
      debug:
        var: mount_check.stdout_lines