---
- name: 🔐 0️⃣ Generar token JWT en master y copiarlo al controller
  hosts: masters[0]
  gather_facts: false
  become: true

  vars:
    kubeconfig_path: "/etc/rancher/k3s/k3s.yaml"
    local_token_path: "/tmp/traefik-token.jwt"
    token_duration: "87600h"  # 10 años

  tasks:
    - name: 🔐 Generar token JWT para usuario 'default' con k3s
      raw: |
        export KUBECONFIG={{ kubeconfig_path }}
        k3s kubectl create token default --duration={{ token_duration }}
      register: token_output
      changed_when: false

    - name: 📄 Guardar token localmente en el master
      raw: |
        echo "{{ token_output.stdout }}" > {{ local_token_path }}

    - name: 🟢 Token generado en master
      debug:
        var: token_output.stdout


- name: 📥 Copiar token JWT desde master al controller
  hosts: controller
  gather_facts: false
  become: true

  vars:
    ssh_key_path: "/root/.ssh/cluster_k3s/shared/id_rsa_shared_cluster"
    ssh_user: "core"
    master_ip: "{{ groups['masters'][0] }}"
    local_token_path: "/tmp/traefik-token.jwt"
    token_dest: "/home/monitoring/.kube/token.jwt"

  tasks:
    - name: 📁 Crear carpeta destino
      file:
        path: "{{ token_dest | dirname }}"
        state: directory
        owner: monitoring
        group: monitoring
        mode: '0755'

    - name: 📥 Copiar token con scp desde el master
      raw: |
        scp -i {{ ssh_key_path }} -o StrictHostKeyChecking=no {{ ssh_user }}@{{ master_ip }}:{{ local_token_path }} {{ token_dest }}
      become: false

    - name: 🔐 Ajustar permisos del token
      file:
        path: "{{ token_dest }}"
        owner: monitoring
        group: monitoring
        mode: '0600'

    - name: 🔒 Verificar token copiado
      command: cat {{ token_dest }}
      register: token_check
      changed_when: false

    - name: 📦 Token copiado al controller
      debug:
        var: token_check.stdout