# playbooks/playbook_cleanup.yml
- name: ‚ôªÔ∏è Limpiar configuraci√≥n de almacenamiento en nodos de storage, workers y controller
  hosts: storage,workers,controller
  become: true
  gather_facts: false

  pre_tasks:
    - name: ‚úÖ Verificaci√≥n de confirmaci√≥n de limpieza
      ansible.builtin.assert:
        that:
          - confirm_cleanup | default(false) | bool
        fail_msg: "‚ùå ERROR: Debe confirmar la limpieza con -e 'confirm_cleanup=yes'"
        success_msg: "üßπ Confirmaci√≥n recibida. Iniciando limpieza del nodo {{ inventory_hostname }}..."

  vars:
    kubeconfig_path: "/home/victory/.kube/config"

  tasks:
    # ------------------------------
    # 1Ô∏è‚É£ Limpieza en el controller (K8s y Helm)
    # ------------------------------
    - name: üóëÔ∏è Eliminar release de Helm de Longhorn
      ansible.builtin.raw: |
        export PATH=$PATH:/usr/local/bin
        export KUBECONFIG={{ kubeconfig_path }}
        helm uninstall longhorn --namespace longhorn-system || true
      when: "'controller' in group_names"

    - name: üßº Eliminar el namespace completo (longhorn-system)
      ansible.builtin.raw: |
        export PATH=$PATH:/usr/local/bin
        export KUBECONFIG={{ kubeconfig_path }}
        kubectl delete namespace longhorn-system --ignore-not-found || true
      when: "'controller' in group_names"

    - name: üßπ Eliminar secrets de Helm relacionados con Longhorn
      ansible.builtin.raw: |
        export PATH=$PATH:/usr/local/bin
        export KUBECONFIG={{ kubeconfig_path }}
        kubectl delete secret -n longhorn-system -l "owner=helm,name=longhorn" || true
      when: "'controller' in group_names"

    - name: üß® Eliminar CustomResourceDefinitions (CRDs) de Longhorn
      ansible.builtin.raw: |
        export PATH=$PATH:/usr/local/bin
        export KUBECONFIG={{ kubeconfig_path }}
        kubectl delete crd -l app.kubernetes.io/name=longhorn || true
      when: "'controller' in group_names"

    - name: üîê Eliminar ServiceAccounts y ConfigMaps residuales
      ansible.builtin.raw: |
        export PATH=$PATH:/usr/local/bin
        export KUBECONFIG={{ kubeconfig_path }}
        kubectl delete serviceaccount longhorn-service-account -n longhorn-system --ignore-not-found || true
        kubectl delete configmap -n longhorn-system --all || true
      when: "'controller' in group_names"

    - name: üõë Forzar limpieza de finalizers (si existen stuck namespaces o CRDs)
      ansible.builtin.raw: |
        export PATH=$PATH:/usr/local/bin
        export KUBECONFIG={{ kubeconfig_path }}
        kubectl get namespace longhorn-system -o json | jq 'del(.spec.finalizers)' | kubectl replace --raw "/api/v1/namespaces/longhorn-system/finalize" -f - || true
      when: "'controller' in group_names"

    - name: üîé Verificar si Longhorn fue eliminado completamente
      ansible.builtin.raw: |
        export PATH=$PATH:/usr/local/bin
        export KUBECONFIG={{ kubeconfig_path }}
        kubectl get all -n longhorn-system || echo "üü¢ Namespace longhorn-system no existe"
      register: longhorn_cleanup_status
      when: "'controller' in group_names"

    - name: üìã Mostrar resultado de limpieza en controller
      ansible.builtin.debug:
        msg: "{{ longhorn_cleanup_status.stdout_lines }}"
      when: "'controller' in group_names"

    # ------------------------------
    # 2Ô∏è‚É£ Limpieza de almacenamiento en storage
    # ------------------------------
    - name: üîå Desmontar vol√∫menes montados
      ansible.builtin.raw: |
        umount -f /srv/nfs/postgresql || true
        umount -f /srv/nfs/shared || true
        umount -f /mnt/longhorn-disk || true
      changed_when: false
      ignore_errors: true

    - name: üõë Detener y deshabilitar NFS
      ansible.builtin.raw: |
        systemctl stop nfs-server || rc-service nfs stop || true
        systemctl disable nfs-server || true
      when: "'storage' in group_names"

    - name: üóëÔ∏è Eliminar vol√∫menes l√≥gicos
      ansible.builtin.raw: |
        lvremove -y /dev/vg_storage/postgres_lv || true
        lvremove -y /dev/vg_storage/shared_lv || true
        lvremove -y /dev/vg_storage/longhorn_lv || true
      when: "'storage' in group_names"

    - name: üß® Eliminar grupo de vol√∫menes
      ansible.builtin.raw: |
        vgremove -y vg_storage || true
      when: "'storage' in group_names"

    - name: üí£ Borrar firma LVM
      ansible.builtin.raw: |
        pvremove -y /dev/vdb1 || true
      when: "'storage' in group_names"

    - name: üö´ Borrar tabla de partici√≥n
      ansible.builtin.raw: |
        parted /dev/vdb rm 1 || true
      when: "'storage' in group_names"

    # ------------------------------
    # 3Ô∏è‚É£ Limpieza de discos en workers
    # ------------------------------
    - name: üßπ Borrar sistema de archivos en /dev/vdb
      ansible.builtin.raw: |
        wipefs -a /dev/vdb || true
      when: "'workers' in group_names"

    # ------------------------------
    # ‚úÖ Mensaje final por nodo
    # ------------------------------
    - name: ‚úÖ Confirmaci√≥n final por nodo
      ansible.builtin.debug:
        msg: "‚úÖ Limpieza completa finalizada en {{ inventory_hostname }}. Puedes reiniciar el nodo si deseas."